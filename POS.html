<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cafe POS System</title>
  <style>
    /* =================================
   1. Base Styles & Reset
   ================================= */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* =================================
   2. Layout & Container
   ================================= */
    .container {
      display: flex;
      height: calc(100vh - 60px);
      padding: 20px;
      gap: 20px;
    }

    /* =================================
   3. Header Styles
   ================================= */
    .header {
      background: #1a73e8;
      color: white;
      padding: 15px 20px;
      font-size: 24px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* =================================
   4. Menu Section Styles
   ================================= */
    .menu-section {
      flex: 75;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 100px);
    }

    .categories {
      display: flex;
      padding: 15px;
      gap: 10px;
      overflow-x: auto;
      background: #f8f9fa;
      flex-shrink: 0;
    }

    .category {
      padding: 8px 16px;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .category.active {
      background: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }

    /* =================================
   5. Menu Items Grid
   ================================= */
    .menu-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      padding: 20px;
      overflow-y: auto;
    }

    .menu-item {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .menu-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .menu-item img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    /* =================================
   6. Order Section Styles
   ================================= */
    .order-section {
      flex: 35;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
    }

    .order-items {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #dee2e6;
    }

    .order-total {
      padding: 15px;
      border-top: 1px solid #dee2e6;
      background: #f8f9fa;
    }

    /* =================================
   7. Button Styles
   ================================= */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
      font-weight: 500;
    }

    .btn-primary {
      background: #1a73e8;
      color: white;
    }

    .btn-primary:hover {
      background: #1557b0;
      transform: translateY(-1px);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    /* =================================
   8. Modal Base Styles
   ================================= */
    .modal {
      position: fixed;
      z-index: 1000;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      width: 600px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      min-height: min-content;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-height: 70vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 30px;
      text-align: center;
      width: 100%;
    }

    /* Adjust modal footer */
    .modal-footer {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #dee2e6;
      flex-shrink: 0;
      /* Prevent footer from shrinking */
    }

    .modal-footer {
      margin-top: 16px;
      padding-top: 16px;
    }

    /* Make sure close button is consistent */
    .modal-footer .btn {
      min-width: 100px;
    }


    /* =================================
   9. Loading Screen
   ================================= */
    .loading {
      position: fixed;
      z-index: 2000;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .spinner {
      width: 64px;
      height: 64px;
      position: relative;
    }

    .spinner-inner {
      width: 100%;
      height: 100%;
      border: 4px solid transparent;
      border-top-color: #1a73e8;
      border-right-color: #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* =================================
   10. Order History Modal Specific
   ================================= */
    /* Modal size adjustments */
    .order-history-modal .modal-content {
      width: 95%;
      max-width: 1200px;
      height: min(800px, 80vh);
      /* Fixed height that fits in viewport */
      padding: 20px;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      /* Prevent content from spilling out */
    }

    /* Smaller header */
    .order-history-modal h2 {
      color: #1a73e8;
      margin-bottom: 16px;
      font-size: 20px;
      font-weight: 600;
      flex-shrink: 0;
      /* Prevent header from shrinking */
    }

    /* =================================
   11. Order History Table
   ================================= */
    .order-history-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 0;
      background: white;
    }

    /* Table header should be sticky but inside the container */
    .order-history-table thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: white;
    }

    #orderHistoryContent {
      flex: 1;
      /* Take remaining space */
      min-height: 0;
      max-height: 60vh;
      /* Important for flex scroll to work */
      overflow-y: auto;
      width: 100%;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }


    .order-history-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #344767;
      padding: 16px;
      text-align: left;
      border-bottom: 2px solid #dee2e6;
      white-space: nowrap;
    }

    .order-history-table td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
      color: #475569;
      transition: background-color 0.2s;
    }

    .order-history-table {
      width: 100%;
      font-size: 13px;
      /* Reduced font size */
    }

    .order-history-table th {
      padding: 12px;
      /* Reduced from 16px */
      font-size: 13px;
    }

    .order-history-table td {
      padding: 8px 12px;
      /* Reduced from 14px 16px */
      font-size: 13px;
    }

    /* Special Rows */
    .date-header {
      background-color: #edf3ff !important;
      font-weight: bold;
      color: #1a73e8 !important;
      text-transform: uppercase;
      font-size: 0.875rem;
      letter-spacing: 0.05em;
    }

    .date-header td {
      padding: 12px 16px !important;
    }

    .daily-total {
      background-color: #f8f9fa !important;
      font-weight: 600;
    }

    .daily-total td {
      padding: 16px !important;
      border-bottom: 2px solid #dee2e6 !important;
      color: #344767 !important;
    }

    /* =================================
   Date Filter Dropdown
   ================================= */
    .date-filter {
      margin-bottom: 20px;
    }

    .date-select {
      width: 300px;
      /* Fixed width */
      padding: 12px 16px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      font-size: 15px;
      color: #344767;
      background: white;
      cursor: pointer;
      appearance: none;
      /* Remove default appearance */
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 12px;
      padding-right: 40px;
    }

    .date-select {
      width: 250px;
      /* Reduced from 300px */
      padding: 8px 12px;
      /* Reduced padding */
      font-size: 13px;
      margin-bottom: 12px;
    }

    .date-select:hover {
      border-color: #1a73e8;
    }

    .date-select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    /* =================================
   12. Payment Status Indicators
   ================================= */
    .payment-status {
      padding: 4px 8px;
      /* Reduced padding */
      font-size: 12px;
      /* Smaller font */
      border-radius: 8px;
    }



    .payment-status.cash {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    .payment-status.card {
      background-color: #e3f2fd;
      color: #1565c0;
    }

    .payment-status.account {
      background-color: #fff3e0;
      color: #e65100;
    }

    .payment-status.instapay {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }

    /* =================================
   13. Animations
   ================================= */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* =================================
   14. Responsive Styles
   ================================= */
    @media (max-width: 768px) {
      .order-history-modal .modal-content {
        width: 100%;
        padding: 16px;
        margin: 0;
        border-radius: 0;
        height: 100vh;
        max-height: 100vh;
      }

      #orderHistoryContent {
        margin: -16px;
        padding: 16px;
      }

      .order-history-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .order-history-table th,
      .order-history-table td {
        padding: 12px;
      }

      .order-history-modal .modal-content {
        height: min(700px, 90vh);
        padding: 16px;
      }

      .date-select {
        width: 100%;
      }
    }

    /* =================================
   15. Payment Methods Modal
   ================================= */
    .payment-methods {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 10px;
      width: 100%;
    }


    .payment-method {
      padding: 30px 25px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 2px solid #e0e0e0;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
      height: 180px;
    }

    .payment-method {
      flex: 1 1 calc(50% - 10px);
      min-width: 200px;
      height: 140px;
      /* Reduced from 180px */
      padding: 20px 15px;
      /* Reduced from 30px 25px */
    }

    .payment-method:hover {
      border-color: #1a73e8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.1);
    }

    .payment-method.selected {
      background: #EBF3FE;
      border-color: #4285F4;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.1);
    }

    .payment-method .icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .payment-method .name {
      font-size: 18px;
      font-weight: 500;
    }

    /* =================================
   16. Email Search (for Account Payment)
   ================================= */
    .email-search-container {
      width: 100%;
      height: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .email-search {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.2s;
    }

    .email-search-container.visible {
      height: auto;
      opacity: 1;
      margin: 20px 0;
      width: 100%;
      max-height: 25vh;
    }

    .email-search:focus {
      border-color: #1a73e8;
      outline: none;
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    }

    .email-dropdown {
      width: 100%;
      margin-top: 8px;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      /* box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); */
      max-height: 200px;
      overflow-y: auto;
      /* position: relative; */
    }


    .email-dropdown {
      max-height: 200px;
      width: calc(100%);
      /* Account for modal padding */
      background: white;
    }


    .email-dropdown {
      position: relative;
      max-height: 200px;
      /* border: 1px solid #e0e0e0; */
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1;
    }


    .email-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 15px;
    }

    .email-option:hover {
      background: #f3f8ff;
    }

    /* Additional responsive styles for payment methods */
    @media (max-width: 520px) {
      .payment-methods {
        grid-template-columns: 1fr;
      }

      .payment-method {
        height: 120px;
        padding: 16px;
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div>Cafe POS System</div>
    <div style="display: flex; gap: 20px; align-items: center;">
      <div id="datetime"></div>
      <button class="btn" style="background: white; color: #1a73e8; font-weight: 500;" onclick="showOrderHistoryModal()">ðŸ“Š Order History</button>
    </div>
  </header>

  <div class="container">
    <section class="menu-section">
      <div class="categories" id="categories"></div>
      <div class="categories" id="subCategories"></div> <!-- Add this line -->
      <div class="menu-items" id="menuItems"></div>
    </section>

    <section class="order-section">
      <div class="order-items" id="orderItems"></div>
      <div class="order-total">
        <div style="margin-bottom: 10px">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px">
            <span>Subtotal:</span>
            <span id="subtotal">EGP 0.00</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px">
            <span>
                            <button class="btn" onclick="showDiscountModal()">Discount: <span id="discountValue">0</span>%</button>
            </span>
            <span id="discount">EGP 0.00</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold">
            <span>Total:</span>
            <span id="total">EGP 0.00</span>
          </div>
        </div>
        <button class="btn btn-primary" style="width: 100%" onclick="showPaymentModal()">Process Payment</button>
      </div>
    </section>
  </div>

  <div class="loading" id="loading">
    <div class="spinner">
      <div class="spinner-inner"></div>
    </div>
  </div>

  <div class="modal" id="orderHistoryModal">
    <div class="modal-content order-history-modal">
      <h2>Order History</h2>

      <div class="date-filter">
        <select id="dateFilter" class="date-select" onchange="handleDateChange()">
          <option value="">Select Date</option>
        </select>
      </div>

      <div id="orderHistoryContent">
        <table class="order-history-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Item</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
              <th>Payment Method</th>
            </tr>
          </thead>
          <tbody id="orderHistoryTableBody">
            <!-- Dynamic content goes here -->
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button class="btn" onclick="hideOrderHistoryModal()">Close</button>
      </div>
    </div>
  </div>



  <div class="modal" id="discountModal">
    <div class="modal-content" style="max-width: 300px;">
      <h2>Set Discount</h2>
      <div class="slider-container">
        <input type="range" id="discountSlider" min="0" max="100" value="0" orient="vertical">
      </div>
      <div style="text-align: center; font-size: 24px; margin-bottom: 20px;">
        <span id="discountSliderValue">0</span>%
      </div>
      <div style="display: flex; justify-content: flex-end; gap: 10px">
        <button class="btn" onclick="hideDiscountModal()">Cancel</button>
        <button class="btn btn-primary" onclick="applyDiscount()">Apply</button>
      </div>
    </div>
  </div>

  <div class="modal" id="paymentModal">
    <div class="modal-content">
      <h2>Select Payment Method</h2>
      <div class="payment-methods" id="paymentMethods"></div>
      <div style="display: flex; justify-content: flex-end; gap: 10px">
        <button class="btn" onclick="hidePaymentModal()">Cancel</button>
        <button class="btn btn-primary" onclick="processPayment()">Confirm Payment</button>
      </div>
    </div>
  </div>

  <script>
    // Mock email list (replace with your actual email list)
    let registeredEmails = [
        'john.doe@company.com',
        'jane.smith@company.com',
        'michael.brown@company.com',
        'sarah.wilson@company.com',
        'robert.johnson@company.com',
        'emma.davis@company.com',
        'william.taylor@company.com',
        'olivia.anderson@company.com',
        'james.martinez@company.com',
        'sophia.thompson@company.com',
        'accounting@company.com',
        'sales@company.com',
        'support@company.com',
        'marketing@company.com',
        'hr@company.com',
        'john.wilson@gmail.com',
        'sarah.brown@gmail.com',
        'mike.davis@gmail.com',
        'emma.taylor@gmail.com',
        'robert.smith@gmail.com'
    ];

    let emailsObj

    const paymentMethods = [
        { id: 'cash', name: 'Cash', icon: 'ðŸ’µ' },
        { id: 'card', name: 'Card', icon: 'ðŸ’³' },
        { id: 'instapay', name: 'InstaPay', icon: 'ðŸ“±' },
        { id: 'account', name: 'Add to Account', icon: 'ðŸ“§' }
    ];

    // Simulated API
const api = {
    async fetchData() {
        let menu = {
            drinks: {
                name: 'Drinks',
                categories: {
                    coffees: {
                        name: 'Coffees',
                        items: [
                            { name: 'Espresso', price: 108, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                            { name: 'Latte', price: 139, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                            { name: 'Cappuccino', price: 124, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                            { name: 'Americano', price: 93, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' }
                        ]
                    },
                    softDrinks: {
                        name: 'Soft Drinks',
                        items: [
                            { name: 'Cola', price: 50, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                            { name: 'Lemonade', price: 45, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                            { name: 'Iced Tea', price: 60, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' }
                        ]
                    },
                    cocktails: {
                        name: 'Cocktails',
                        items: [
                            { name: 'Mojito', price: 200, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                            { name: 'Margarita', price: 220, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                            { name: 'Cosmopolitan', price: 240, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' }
                        ]
                    }
                }
            },
            food: {
                name: 'Food',
                items: [
                    { name: 'Croissant', price: 93, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                    { name: 'Muffin', price: 77, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                    { name: 'Sandwich', price: 201, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' },
                    { name: 'Salad', price: 247, image: 'https://drive.google.com/file/d/1H05vl_RtDUoHZeGp1Z_X5vqBuZtKHAr-/view?usp=drive_link' }
                ]
            }
        };


        try{
            const combinedObjString = await new Promise((resolve,reject) => {
              google.script.run
                .withSuccessHandler(resolve) // Resolve the Promise on success
                .withFailureHandler(reject)  // Reject the Promise on failure
                .getMenuItems();       // Call your server-side function
            });
            const combinedObj = JSON.parse(combinedObjString)
            console.log(combinedObj)
            menu = combinedObj.menuObj
            emailsObj = combinedObj.emailsObj
            registeredEmails = Object.keys(emailsObj)
            // console.log(menu)
            console.log("success")
          } catch (error) {
            console.error("Error:", error);
          }
  
        return { menu, paymentMethods };
    },


    async submitOrder(order) {
      order.orderId = Math.random().toString(36).substr(2, 9)
      console.log(order)
      console.log(JSON.stringify(order))
      let successBool = false
          try{
            successBool = await new Promise((resolve,reject) => {
              google.script.run
                .withSuccessHandler(resolve) // Resolve the Promise on success
                .withFailureHandler(reject)  // Reject the Promise on failure
                .submitOrder(order);       // Call your server-side function
            });
            console.log("success")
          } catch (error) {
            console.error("Error:", error);
          }
  
        return { success: successBool, orderId: order.orderId };
    },

      async fetchOrderHistory() {
      try {
         const historyData = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getOrderHistory();
        });
        globalHistoryData = JSON.parse(historyData);
      } catch (error) {
        console.error("Error fetching order history:", error);
        throw error;
      }
    }
};

let globalHistoryData = {}; // Store the complete order history


// State management
let state = {
    menu: null,
    paymentMethods: null,
    currentCategory: null,
    currentSubCategory: null,
    selectedEmail: null,
    order: {
        items: [],
        discount: 0, // Default 0% discount
        paymentMethod: null
    }
};

// UI management
function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showPaymentModal() {
    if (state.order.items.length === 0) {
        alert('Please add items to your order');
        return;
    }
    document.getElementById('paymentModal').style.display = 'flex';
}

function hidePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
    state.order.paymentMethod = null;
    renderPaymentMethods();
}

function selectPaymentMethod(methodId) {
    state.order.paymentMethod = methodId;
    renderPaymentMethods();
}

// async function processPayment() {
//     if (!state.order.paymentMethod) {
//         alert('Please select a payment method');
//         return;
//     }

//     showLoading();
//     try {
//         const result = await api.submitOrder(state.order);
//         if (result.success) {
//             alert(`Order completed successfully! Order ID: ${result.orderId}`);
//             state.order.items = [];
//             state.order.paymentMethod = null;
//             renderOrder();
//             hidePaymentModal();
//         }
//     } catch (error) {
//         alert('Failed to process payment. Please try again.');
//     }
//     hideLoading();
// }

async function processPayment() {
    if (!state.order.paymentMethod) {
        alert('Please select a payment method');
        return;
    }

    if (state.order.paymentMethod === 'account' && !state.selectedEmail) {
        alert('Please select an account email');
        return;
    }

    showLoading();
    try {
        const orderData = {
            ...state.order,
            accountEmail: emailsObj[state.selectedEmail]
        };
        console.log(orderData)
        const result = await api.submitOrder(orderData);
        if (result.success) {
            alert(`Order completed successfully! Order ID: ${result.orderId}`);
            state.order.items = [];
            state.order.paymentMethod = null;
            state.selectedEmail = null;
            renderOrder();
            hidePaymentModal();
        }
    } catch (error) {
        alert('Failed to process payment. Please try again.');
    }
    hideLoading();
}

function addToOrder(item) {
    const existingItem = state.order.items.find(i => i.name === item.name);
    if (existingItem) {
        existingItem.quantity += 1; // Increment quantity if item already exists
    } else {
        state.order.items.push({ ...item, quantity: 1 }); // Add new item with quantity 1
    }
    renderOrder();
}

function removeFromOrder(index) {
    const item = state.order.items[index];
    if (item.quantity > 1) {
        item.quantity -= 1; // Decrement quantity if greater than 1
    } else {
        state.order.items.splice(index, 1); // Remove item if quantity is 1
    }
    renderOrder();
}

// Rendering functions
function renderCategories() {
    const container = document.getElementById('categories');
    container.innerHTML = '';

    Object.keys(state.menu).forEach(categoryId => {
        const category = state.menu[categoryId];
        const element = document.createElement('div');
        element.className = `category ${categoryId === state.currentCategory ? 'active' : ''}`;
        element.textContent = category.name;
        element.onclick = () => {
            state.currentCategory = categoryId;
            state.currentSubCategory = null; // Reset subcategory when switching categories
            renderCategories();
            renderSubCategories();
            renderMenuItems();
        };
        container.appendChild(element);
    });

    if (!state.currentCategory) {
        state.currentCategory = Object.keys(state.menu)[0];
        renderCategories();
        renderSubCategories();
        renderMenuItems();
    }
}

function renderSubCategories() {
    const container = document.getElementById('subCategories');
    container.innerHTML = '';

    const category = state.menu[state.currentCategory];
    if (category.categories) {
        Object.keys(category.categories).forEach(subCategoryId => {
            const subCategory = category.categories[subCategoryId];
            const element = document.createElement('div');
            element.className = `category ${subCategoryId === state.currentSubCategory ? 'active' : ''}`;
            element.textContent = subCategory.name;
            element.onclick = () => {
                state.currentSubCategory = subCategoryId;
                renderSubCategories();
                renderMenuItems();
            };
            container.appendChild(element);
        });
    }
}

function renderMenuItems() {
    const container = document.getElementById('menuItems');
    container.innerHTML = '';

    const category = state.menu[state.currentCategory];
    let items = [];

    if (category.categories && state.currentSubCategory) {
        items = category.categories[state.currentSubCategory].items;
    } else if (category.items) {
        items = category.items;
    }

    items.forEach(item => {
        const element = document.createElement('div');
        element.className = 'menu-item';
        element.innerHTML = `
            <img src="${item.image}" alt="${item.name}">
            <div>${item.name}</div>
            <div>EGP ${item.price.toFixed(2)}</div>
        `;
        element.onclick = () => addToOrder(item);
        container.appendChild(element);
    });
}

function renderOrder() {
    const container = document.getElementById('orderItems');
    container.innerHTML = '';

    state.order.items.forEach((item, index) => {
        const element = document.createElement('div');
        element.className = 'order-item';
        element.innerHTML = `
            <div>${item.name} (x${item.quantity})</div>
            <div style="display: flex; align-items: center; gap: 10px">
                <div>EGP ${(item.price * item.quantity).toFixed(2)}</div>
                <button class="btn" onclick="removeFromOrder(${index})">Ã—</button>
            </div>
        `;
        container.appendChild(element);
    });

    const subtotal = state.order.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const discount = subtotal * (state.order.discount / 100);
    const total = subtotal - discount;

    document.getElementById('subtotal').textContent = `EGP ${subtotal.toFixed(2)}`;
    document.getElementById('discount').textContent = `EGP ${discount.toFixed(2)}`;
    document.getElementById('total').textContent = `EGP ${total.toFixed(2)}`;
}

function renderPaymentMethods() {
    const container = document.getElementById('paymentMethods');
    container.innerHTML = '';

    // Create payment methods grid
    const methodsGrid = document.createElement('div');
    methodsGrid.className = 'payment-methods';

    state.paymentMethods.forEach(method => {
        const element = document.createElement('div');
        element.className = `payment-method ${method.id === state.order.paymentMethod ? 'selected' : ''}`;
        element.innerHTML = `
            <div class="icon">${method.icon}</div>
            <div class="name">${method.name}</div>
        `;
        element.onclick = () => selectPaymentMethod(method.id);
        methodsGrid.appendChild(element);
    });

    container.appendChild(methodsGrid);

    // Add email search if account payment is selected
    if (state.order.paymentMethod === 'account') {
        const emailContainer = document.createElement('div');
        // emailContainer.className = 'email-search-container';
        emailContainer.className = 'email-search-container visible';
        emailContainer.innerHTML = `
            <input type="text" 
                class="email-search" 
                placeholder="Search email..."
                value="${state.selectedEmail || ''}"
            >
            <div class="email-dropdown"></div>
        `;
        container.appendChild(emailContainer);

        const searchInput = emailContainer.querySelector('.email-search');
        const dropdown = emailContainer.querySelector('.email-dropdown');

        searchInput.addEventListener('input', (e) => {
            const value = e.target.value.toLowerCase();
            const filtered = registeredEmails.filter(email => 
                email.toLowerCase().includes(value)
            );

            if (value && !filtered.length) {
                searchInput.style.borderColor = '#dc3545';
            } else {
                searchInput.style.borderColor = '#e0e0e0';
            }

            dropdown.style.display = filtered.length ? 'block' : 'none';
            dropdown.innerHTML = filtered.map(email => {
                const index = email.toLowerCase().indexOf(value.toLowerCase());
                if (index >= 0) {
                    const before = email.slice(0, index);
                    const match = email.slice(index, index + value.length);
                    const after = email.slice(index + value.length);
                    return `<div class="email-option">${before}<span style="background-color: #e3f2fd; font-weight: bold">${match}</span>${after}</div>`;
                }
                return `<div class="email-option">${email}</div>`;
            }).join('');
        });

        dropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('email-option')) {
                state.selectedEmail = e.target.textContent;
                searchInput.value = state.selectedEmail;
                dropdown.style.display = 'none';
                searchInput.style.borderColor = '#e0e0e0';
            }
        });

        searchInput.addEventListener('blur', () => {
            setTimeout(() => {
                if (!registeredEmails.includes(searchInput.value)) {
                    searchInput.value = state.selectedEmail || '';
                    searchInput.style.borderColor = '#e0e0e0';
                }
            }, 200);
        });

        setTimeout(() => searchInput.focus(), 0);
        }
}

// function renderPaymentMethods() {
//     const container = document.getElementById('paymentMethods');
//     container.innerHTML = '';

//     state.paymentMethods.forEach(method => {
//         const element = document.createElement('div');
//         element.className = `payment-method ${method.id === state.order.paymentMethod ? 'selected' : ''}`;
//         element.innerHTML = `
//             <div style="font-size: 24px">${method.icon}</div>
//             <div>${method.name}</div>
//         `;
//         element.onclick = () => selectPaymentMethod(method.id);
//         container.appendChild(element);
//     });
// }

function showDiscountModal() {
    document.getElementById('discountModal').style.display = 'flex';
    document.getElementById('discountSlider').value = state.order.discount;
    document.getElementById('discountSliderValue').textContent = state.order.discount;
}

function hideDiscountModal() {
    document.getElementById('discountModal').style.display = 'none';
}

function applyDiscount() {
    const value = document.getElementById('discountSlider').value;
    state.order.discount = Number(value);
    document.getElementById('discountValue').textContent = value;
    renderOrder();
    hideDiscountModal();
}

// Add event listener for slider
document.getElementById('discountSlider')?.addEventListener('input', function() {
    document.getElementById('discountSliderValue').textContent = this.value;
});


function updateDateTime() {
    const now = new Date();
    document.getElementById('datetime').textContent = now.toLocaleString();
}

////////////// ORDERS HISTORY

// Function to show the modal and load initial data
async function showOrderHistoryModal() {
  document.getElementById('orderHistoryModal').style.display = 'flex';
  showLoading();
  
  try {
    await api.fetchOrderHistory();
    
    console.log(globalHistoryData)
    console.log(Object.keys(globalHistoryData))
    // Populate date dropdown
    populateDateFilter(globalHistoryData);
    const dates = Object.keys(globalHistoryData)
    .sort((a, b) => new Date(b) - new Date(a)).reverse();

    console.log(dates)
    if (dates.length > 0) {
      const mostRecentDate = dates[0];
      renderOrderHistory(mostRecentDate, globalHistoryData[mostRecentDate]);
    } else {
      renderOrderHistory(null, null);
    }
    
  } catch (error) {
    alert('Failed to load order history. Please try again.');
    console.log(error)
  } finally {
    hideLoading();
  }
}

// Function to populate the date dropdown
function populateDateFilter() {
  const dateFilter = document.getElementById('dateFilter');
  dateFilter.innerHTML = '<option value="">Select Date</option>';
  
  Object.keys(globalHistoryData)
    .sort((a, b) => new Date(b) - new Date(a))
    .reverse()
    .forEach(date => {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      dateFilter.innerHTML += `<option value="${date}">${formattedDate}</option>`;
    });
}

// Function to handle date change - now uses stored data
function handleDateChange() {
  const dateFilter = document.getElementById('dateFilter');
  const selectedDate = dateFilter.value;
  if (!selectedDate || !globalHistoryData) return;
  console.log(globalHistoryData)
  renderOrderHistory(selectedDate, globalHistoryData[selectedDate]);
}

// Function to hide the modal
function hideOrderHistoryModal() {
  document.getElementById('orderHistoryModal').style.display = 'none';
}

// Function to render orders for a specific date
function renderOrderHistory(selectedDate, ordersArray) {
  const tbody = document.getElementById('orderHistoryTableBody');
  tbody.innerHTML = '';

  if (!ordersArray || ordersArray.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6">
          <div class="empty-state">
            <i>ðŸ“Š</i>
            <h3>No Orders For Selected Date</h3>
            <p>Try selecting a different date to view orders.</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  // Initialize daily total
  let dailyTotal = 0;

  // Add each order's items
  ordersArray.forEach(order => {
    order.items.forEach(item => {
      const itemTotal = item.price * item.quantity;
      dailyTotal += itemTotal;

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${new Date(order.date).toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit'
        })}</td>
        <td>${item.name}</td>
        <td>${item.quantity}</td>
        <td>EGP ${item.price.toFixed(2)}</td>
        <td>EGP ${itemTotal.toFixed(2)}</td>
        <td>
          <span class="payment-status ${order.paymentMethod.toLowerCase()}">
            ${order.paymentMethod}
          </span>
        </td>
      `;
      tbody.appendChild(row);
    });
  });

  // Add daily total row
  const totalRow = document.createElement('tr');
  totalRow.className = 'daily-total';
  totalRow.innerHTML = `
    <td colspan="4">Daily Total:</td>
    <td colspan="2">EGP ${dailyTotal.toFixed(2)}</td>
  `;
  tbody.appendChild(totalRow);
}

// Initialize
async function initialize() {
    showLoading();
    try {
        const data = await api.fetchData();
        state.menu = data.menu;
        state.paymentMethods = data.paymentMethods;
        renderCategories();
        renderSubCategories();
        renderMenuItems();
        renderOrder();
        renderPaymentMethods();
    } catch (error) {
        alert('Failed to load data. Please refresh the page.');
    }
    hideLoading();
    updateDateTime();
    setInterval(updateDateTime, 1000);
}

initialize();
  </script>
</body>

</html>